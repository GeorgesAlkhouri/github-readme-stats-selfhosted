---
name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      new_version:
        description: "Optional release version (e.g. 1.3.0 or v1.3.0). Leave empty to auto-bump minor."
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
      security-events: write

    if: github.event_name == 'workflow_dispatch' || github.actor == 'renovate[bot]'

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Compute next version tag
        id: version
        env:
          INPUT_NEW_VERSION: ${{ github.event.inputs.new_version || '' }}
        run: |
          # If manual input is provided, use that; otherwise bump minor
          if [ -n "${INPUT_NEW_VERSION}" ]; then
            echo "Using manually provided version: ${INPUT_NEW_VERSION}"
            # Strip leading "v" if user provided it
            new_version="${INPUT_NEW_VERSION#v}"
          else
            echo "No manual version provided, computing next minor..."
            latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            version=${latest_tag#v}

            IFS='.' read -r major minor patch <<<"$version"
            minor=$((minor + 1))
            new_version="$major.$minor.0"

            echo "Latest tag:  $latest_tag"
          fi
          new_tag="v$new_version"

          echo "Latest tag:  $latest_tag"
          echo "New tag:     $new_tag"
          echo "New version: $new_version"

          # Expose to later steps
          echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
          echo "NEW_TAG=$new_tag" >> "$GITHUB_ENV"
          echo "NEW_VERSION=$new_version" >> "$GITHUB_ENV"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/github-readme-stats-selfhosted
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/github-readme-stats-selfhosted
          tags: |
            type=semver,pattern={{version}},value=${{ env.NEW_TAG }}
            type=semver,pattern={{major}}.{{minor}},value=${{ env.NEW_TAG }}
            type=semver,pattern={{major}},value=${{ env.NEW_TAG }}

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Trivy scan pushed image (SARIF for Security tab)
        uses: aquasecurity/trivy-action@0.34.1
        with:
          image-ref: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/github-readme-stats-selfhosted:${{ env.NEW_VERSION }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          limit-severities-for-sarif: true

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif
          category: trivy-image

      - name: Create GitHub release (creates tag if missing)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.NEW_TAG }}
          name: ${{ env.NEW_TAG }}
          generate_release_notes: true
          target_commitish: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
